---
import type { Tag } from "@/lib/types";
import tagsData from "@/data/tags.json";
import Button from "@/components/ui/Button.astro";
import Select from "@/components/ui/Select.astro";
import Input from "@/components/ui/Input.astro";

const allTags = (tagsData as Tag[]);
const url = new URL(Astro.url);
const currentSource = url.searchParams.get("source"); // gist|zenn
const currentTag = url.searchParams.get("tag");
const currentQ = url.searchParams.get("q");

function linkWith(next: Record<string, string | null>): string {
  const u = new URL(Astro.url);
  for (const [k, v] of Object.entries(next)) {
    if (v === null) u.searchParams.delete(k);
    else u.searchParams.set(k, v);
  }
  return u.pathname + (u.search ? u.search : "");
}
---

<form class="flex flex-wrap gap-3 items-center" aria-label="フィルタ" method="get" action={new URL(Astro.url).pathname}>
  {currentSource && <input type="hidden" name="source" value={currentSource} />}
  {currentTag && <input type="hidden" name="tag" value={currentTag} />}
  <fieldset class="flex items-center gap-2">
    <legend class="sr-only">ソース</legend>
    <Button href={linkWith({ source: null })} variant={currentSource ? "outline" : "primary"} size="sm" ariaLabel="すべて">
      All
    </Button>
    <Button href={linkWith({ source: "gist" })} variant={currentSource === "gist" ? "primary" : "outline"} size="sm" ariaLabel="Gist のみ">
      Gist
    </Button>
    <Button href={linkWith({ source: "zenn" })} variant={currentSource === "zenn" ? "primary" : "outline"} size="sm" ariaLabel="Zenn のみ">
      Zenn
    </Button>
  </fieldset>

  <label class="text-sm flex items-center gap-2">
    <span>タグ</span>
    <Select
      name="tag"
      size="sm"
      value={currentTag ?? ""}
      options={[{ value: "", label: "すべて" }, ...allTags.map((t) => ({ value: t.norm, label: t.norm }))]}
      on:change={(e) => (location.href = linkWith({ tag: (e.target as HTMLSelectElement).value || null }))}
    />
  </label>

  <label class="text-sm flex items-center gap-2 ml-auto">
    <span>検索</span>
    <Input name="q" size="sm" value={currentQ ?? ""} placeholder="タイトル/要約" />
    <Button type="submit" variant="secondary" size="sm">検索</Button>
  </label>
</form>
