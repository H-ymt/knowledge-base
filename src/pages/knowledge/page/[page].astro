---
import Layout from "../../../layouts/Layout.astro";
import entriesData from "@/data/entries.json";
import type { KnowledgeEntry } from "@/lib/types";
import Filters from "@/components/Filters.astro";
import KnowledgeCard from "@/components/KnowledgeCard.astro";

export interface Props {
  page: number;
  items: KnowledgeEntry[];
  total: number;
}

export async function getStaticPaths() {
  const entries = entriesData as KnowledgeEntry[];
  const pageSize = 20;
  const totalPages = Math.ceil(entries.length / pageSize);
  return Array.from({ length: totalPages - 1 }, (_, i) => {
    const page = i + 2; // 2 ページ目以降
    const start = (page - 1) * pageSize;
    const items = entries.slice(start, start + pageSize);
    return { params: { page: String(page) }, props: { page, items, total: entries.length } satisfies Props };
  });
}

const { page, items, total } = Astro.props as Props;
const pageSize = 20;
const totalPages = Math.ceil(total / pageSize);
---

<Layout>
  <section class="container mx-auto space-y-6 p-6">
    <header class="space-y-1">
      <h1 class="text-3xl">Knowledge</h1>
      <p class="text-main-body-lighter text-sm">{total} 件 / ページ {page} / {totalPages}</p>
    </header>

    <Filters />

    <ul class="space-y-4">
      {
        items.map((e) => (
          <li>
            <KnowledgeCard entry={e} />
          </li>
        ))
      }
    </ul>

    <nav class="flex items-center justify-between text-sm" aria-label="ページネーション">
      <div>
        {
          page > 1 && (
            <a
              data-keep-search="1"
              class="border-main-300 hover:bg-main-50 rounded border px-3 py-1"
              href={page === 2 ? "/knowledge" : `/knowledge/page/${page - 1}`}
            >
              ← 前のページ
            </a>
          )
        }
      </div>
      <div>
        {
          page < totalPages && (
            <a data-keep-search="1" class="border-main-300 hover:bg-main-50 rounded border px-3 py-1" href={`/knowledge/page/${page + 1}`}>
              次のページ →
            </a>
          )
        }
      </div>
    </nav>
  </section>

  <script>
    const qs = window.location.search;
    if (qs) {
      document.querySelectorAll('a[data-keep-search="1"]').forEach((a) => {
        try {
          const u = new URL(a.href, location.origin);
          if (!u.search) u.search = qs;
          else if (!u.search.includes(qs.slice(1))) u.search += (u.search ? "&" : "?") + qs.slice(1);
          a.href = u.pathname + u.search;
        } catch {}
      });
    }
  </script>
</Layout>
